<%= render "shared/page_header",
    title: "Record Session",
    context: @table.name,
    description: "Record a new poker session" %>

<%= form_with model: [@table, @game_session], class: "space-y-6", data: { controller: "session-form" } do %>
  <%# Game Format Selection %>
  <div class="bg-primary-800/50 backdrop-blur-sm rounded-xl border border-primary-700/50 p-4">
    <div class="flex items-center space-x-3 mb-4">
      <%= tabler_icon "cards", size: 20, class: "text-secondary-400" %>
      <h3 class="text-primary-50 font-mono">Game Format</h3>
    </div>

    <%= select_tag :game_format_id,
        options_from_collection_for_select(@game_formats, :id, :name),
        class: "w-full bg-primary-800/50 border-primary-700/50 rounded-lg px-3 py-2 
               font-mono text-primary-50 focus:border-secondary-400 focus:ring-1 focus:ring-secondary-400",
        data: { action: "change->session-form#updateFormat" } %>
  </div>

  <%# Players Selection %>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    <% @available_players.each do |player| %>
      <div class="bg-primary-800/50 backdrop-blur-sm rounded-xl border border-primary-700/50 p-4 cursor-pointer"
           data-session-form-target="playerCard"
           data-action="click->session-form#togglePlayer">
        <%# Player Header %>
        <div class="flex items-center space-x-3">
          <span class="text-2xl"><%= player.emoji %></span>
          <h3 class="text-primary-50 font-mono font-medium"><%= player.name %></h3>
          <%= check_box_tag "player_ids[]", player.id, false,
              class: "hidden",
              data: { session_form_target: "playerCheckbox" } %>
        </div>

        <%# Chip Counts (initially hidden) %>
        <div class="hidden mt-4 space-y-3" data-session-form-target="chipInputs">
          <% @game_formats.first.denominations.sort_by { |d| -d['value'].to_f }.each do |denomination| %>
            <div class="flex items-center space-x-3">
              <div class="w-4 h-4 rounded-full border border-primary-600 flex-shrink-0"
                   style="background-color: <%= GameFormat::VALID_COLORS[denomination['color']] %>"></div>
              
              <div class="flex-grow">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-mono text-primary-300">
                    $<%= number_with_precision(denomination['value'], precision: 2) %>
                  </span>
                  <%= number_field_tag "player_results[#{player.id}][chip_counts][#{denomination['color']}]",
                      nil, min: 0, step: 1,
                      class: "w-20 bg-primary-800/50 border-primary-700/50 rounded-lg px-3 py-1 
                             text-right font-mono text-primary-50 focus:border-secondary-400 focus:ring-1 focus:ring-secondary-400
                             [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none",
                      data: { 
                        session_form_target: "chipInput",
                        value: denomination['value'].to_f,
                        action: "input->session-form#updateTotals"
                      } %>
                </div>
              </div>
            </div>
          <% end %>

          <%# Player Total %>
          <div class="flex items-center justify-between pt-3 border-t border-primary-700/50">
            <span class="font-mono text-primary-300">Total</span>
            <span class="font-mono text-primary-50"
                  data-session-form-target="playerTotal"
                  data-player-id="<%= player.id %>">
              $0.00
            </span>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <%# Grand Total %>
  <div class="flex justify-between items-center mt-6">
    <div class="flex items-center space-x-6">
      <%= link_to "Cancel", table_game_sessions_path(@table),
          class: "px-4 py-2 rounded-lg font-mono text-primary-400 hover:text-primary-50 hover:bg-primary-800/50" %>
      
      <div>
        <span class="font-mono text-primary-400">Grand Total:</span>
        <span class="ml-2 font-mono text-primary-50" data-session-form-target="grandTotal">$0.00</span>
        <span class="ml-2 font-mono text-primary-400" data-session-form-target="expectedTotal"></span>
      </div>
    </div>
    
    <%= button_tag type: :submit,
        class: "px-4 py-2 rounded-lg font-mono text-primary-900 bg-secondary-400 
               hover:bg-secondary-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200",
        data: { session_form_target: "submit" } do %>
      Complete Session
    <% end %>
  </div>
<% end %> 